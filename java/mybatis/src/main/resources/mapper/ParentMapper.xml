<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.ParentMapper">

    <update id="createTable">
        CREATE TABLE IF NOT EXISTS parent (
            id int NOT NULL GENERATED BY DEFAULT AS IDENTITY,
            name varchar(255) NOT NULL,
            PRIMARY KEY (id)
        )
    </update>

    <resultMap id="parentResult" type="Parent">
        <id property="id" column="parent_id" />
        <result property="name" column="parent_name" />
        <collection property="children" ofType="Child" resultMap="childResult" columnPrefix="child_" />
    </resultMap>

    <resultMap id="childResult" type="Child">
        <id property="id" column="id" />
        <result property="name" column="name" />
    </resultMap>

    <insert id="save" parameterType="Parent" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO parent (name)
        VALUES (#{name})
    </insert>

    <select id="findAllParents" resultMap="parentResult">
        <include refid="selectParents" />
    </select>

    <select id="findParentsByName" resultMap="parentResult">
        <include refid="selectParents" />
        WHERE p.name = #{name}
    </select>

    <sql id="selectParents">
        SELECT
            p.id        as parent_id,
            p.name      as parent_name,
            c.id        as child_id,
            c.name      as child_name,
            c.parent_id as child_parent_id
        FROM parent p LEFT OUTER JOIN child c ON p.id = c.parent_id
    </sql>

</mapper>